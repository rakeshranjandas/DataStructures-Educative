package heaps;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Comparator;
import java.util.HashSet;
import java.util.List;
import java.util.PriorityQueue;
import java.util.Set;

public class SlidingWindowMedian {

    public static class Pair {
        int value;
        int index;

        public Pair(int index, int value) {
            this.index = index;
            this.value = value;
        }

        public String toString() {
            return "{" + index + "," + value + "}";
        }
    }

    public static class CPriorityQueue {
        PriorityQueue<Pair> pq;
        Set<Integer> activeIndices = new HashSet<>();

        public CPriorityQueue(Comparator<Pair> cp) {
            pq = new PriorityQueue<Pair>(cp);
        }

        public int size() {
            return activeIndices.size();
        }

        public void add(Pair p) {
            pq.add(p);
            activeIndices.add(p.index);
        }

        public int peekValue() {
            clearTop();
            return pq.peek().value;
        }

        public void removeIndex(int index) {
            activeIndices.remove(index);
        }

        public boolean hasIndex(int index) {
            return activeIndices.contains(index);
        }

        public void clearTop() {
            while (!pq.isEmpty() && !activeIndices.contains(pq.peek().index)) {
                pq.poll();
            }
        }

        public Pair poll() {
            clearTop();
            Pair poppedPair = pq.poll();
            activeIndices.remove(poppedPair.index);
            return poppedPair;
        }

        public void print() {
            System.out.println(pq);
            System.out.println(pq.peek());
            System.out.println(activeIndices);
        }
    }

    private static class Bag {
        CPriorityQueue leftHeap, rightHeap;

        public Bag() {
            leftHeap = new CPriorityQueue((Pair a, Pair b) -> Integer.compare(b.value, a.value));
            rightHeap = new CPriorityQueue((Pair a, Pair b) -> Integer.compare(a.value, b.value));
        }

        public void add(int index, int value) {
            Pair newPair = new Pair(index, value);

            if (rightHeap.size() == 0) {
                rightHeap.add(newPair);

            } else if (value >= rightHeap.peekValue()) {
                rightHeap.add(newPair);

            } else {
                leftHeap.add(newPair);
            }

            balance();
        }

        private void balance() {
            // 1 - Ensures bag weights are same (or left is smaller than right by 1)
            // 2 - Top of both bags are active indices

            while (rightHeap.size() - leftHeap.size() > 1) {
                leftHeap.add(rightHeap.poll());
            }

            while (leftHeap.size() - rightHeap.size() > 0) {
                rightHeap.add(leftHeap.poll());
            }

            leftHeap.clearTop();
            rightHeap.clearTop();
        }

        public void remove(int index) {
            if (leftHeap.hasIndex(index)) {
                leftHeap.removeIndex(index);

            } else if (rightHeap.hasIndex(index)) {
                rightHeap.removeIndex(index);
            }

            balance();
        }

        public double getMedian() {

            System.out.println("leftHeap: ");
            leftHeap.print();

            System.out.println("rightHeap: ");
            rightHeap.print();

            System.out.println("----------");

            if (leftHeap.size() == rightHeap.size()) {
                return ((double) leftHeap.peekValue() + rightHeap.peekValue()) / 2;
            }

            return (double) rightHeap.peekValue();
        }
    }

    public static double[] medianSlidingWindow(int[] nums, int k) {

        // Imagine 2 bags that will hold the nums.
        // Each num has a weight, if and only if they are active in the window.
        // Ideally the bags size should be equal,
        // or left bag should be at max one less than right_bag
        //
        // When window slides,
        // outgoing number creates hole in the bag
        // incoming number adds weight
        //
        // We need to balance the bags again for this window

        List<Double> res = new ArrayList<>();
        Bag bag = new Bag();

        for (int i = 0; i < k; i++) {
            bag.add(i, nums[i]);
        }

        res.add(bag.getMedian());

        for (int i = k; i < nums.length; i++) {
            bag.remove(i - k);
            bag.add(i, nums[i]);
            res.add(bag.getMedian());
        }

        return res.stream().mapToDouble(Double::doubleValue).toArray();
    }

    public static void main(String[] args) {
        int[] nums = new int[] { -2112824819, -527302001, -655606964, -1501741766, -2036754422, -1181061337,
                -1650715054, -1099710857, -1321457460, -833989486, -2119041163, -487150528, -1985832707, -1477700278,
                -1688010965, -1045983573, -1660877233, -198830086, -26728427, -1881286949, -1432044757, -221529938,
                -126193361, -966887583, -65811791, -1320726776, -1563811484, -1122996251, -482646020, -948821135,
                -314290935, -534467165, -1799204210, -894914006, -924429652, -955724857, -348182342, -1925920318,
                -1227756020, -532505399, -1723840006, -1328181526, -704883, -491239408, -1200112440, -1609476013,
                -2129402014, -1690290469, -1367041496, -691409658, -766182013, -1374805816, -680931969, -1834816827,
                -51216039, -660302366, -1803166230, -136795013, -347882153, -605346628, -535364320, -953703570,
                -824527205, -1433505719, -1385200993, -411456331, -1932597052, -112058000, -1434675024, -659078574,
                -1032773802, -487604135, -992549806, -838094472, -386273985, -1120768956, -1115687586, -300043098,
                -199981461, -1586412786, -1493788814, -162452103, -288480149, -75501391, -1188469989, -474250866,
                -1354266467, -338217370, -1890818403, -715284758, -2048965615, -95280132, -99847440, -889153617,
                -1436093816, -1920028321, -160792920, -1065109660, -66711242, -1162117943, -1411932401, -1288182784,
                -982417473, -2125030222, -1517671831, -1750972500, -197711965, -1441022635, -1322459058, -119990503,
                -2122717061, -502620571, -1659460858, -1470429791, -92858540, -558654383, -76397028, -1339396509,
                -553894805, -1500338048, -918626017, -859384278, -1851893419, -613551014, -1073189025, -2006041502,
                -253004261, -381754655, -1643120628, -1513010695, -2113358010, -7619, -1038509459, -9566556,
                -2003595261, -1703654002, -2011554858, -1172935548, -913110784, -2103494942, -667649688, -1909821169,
                -1887035444, -1198839380, -1950111239, -13823770, -1581434088, -1408103166, -1679568745, -46951950,
                -269735371, -1652784622, -169661789, -1026458902, -1587375742, -915105051, -2067907592, -159217405,
                -811859548, -555880841, -691782972, -1771356979, -1416661964, -1165230844, -1829979003, -1577564470,
                -1631894928, -1433435964, -1614853883, -684657309, -1284699862, -812043304, -190047770, -1380706362,
                -1164941765, -660190664, -1456545464, -986124030, -446069623, -1861880336, -194102586, -1619581794,
                -1663499202, -1611844684, -1579301516, -748469846, -1582218522, -1989532108, -562890911, -1527760278,
                -338588406, -312054510, -1725708189, -1358817549, -2143660530, -1189142984, -522612177, -1178606510,
                -36317825, -1548004307, -549889844, -1617460250, -342418731, -305657025, -1742025267, -612721212,
                -102237647, -808508740, -1061193987, -1232161880, -1581619111, -1420160832, -1125388317, -881295378,
                -1064015480, -1340169663, -1266245168, -505697188, -1943887802, -599083112, -2094231080, -1568391230,
                -1825598326, -759950922, -623445099, -710126870, -872065953, -945923241, -1766635980, -1272512016,
                -535843426, -1716756192, -1709408425, -915402966, -1870283603, -1233018444, -1309549561, -995500527,
                -1682193031, -1556236218, -1244623617, -1634622519, -1086463587, -1760224324, -1413171828, -439946182,
                -608147897, -1669708757, -278045790, -552238162, -455269649, -233048747, -1109526759, -2094295020,
                -863097059, -2133868779, -1453499537, -1225412403, -1189801136, -1912008279, -453365770, -623312452,
                -413946775, -174522003, -21732508, -1719637258, -1322760071, -634270839, -1167851515, -638083800,
                -993640952, -438404667, -922674243, -2019984878, -478149403, -1530038799, -574593943, -672028461,
                -2078337450, -1314958649, -30909057, -997335125, -1847815289, -506188627, -1601315509, -407970867,
                -937278486, -311439711, -2122279346, -986928068, -1922515487, -888749124, -2118031829, -358515189,
                -458051174, -1297679587, -1079725451, -680204781, -1025480040, -1209779271, -1009279296, -1234359869,
                -445649924, -457707201, -982869286, -1080069773, -69477578, -1293228062, -1640065810, -2040809826,
                -21279879, -1048328509, -186562467, -1388966765, -2007807936, -1319667681, -368617715, -407438922,
                -584525094, -1266427270, -1809727940, -1669891465, -246742015, -1188789404, -1605904993, -1211596186,
                -1866499982, -471963940, -1027276525, -1085036235, -2147086709, -611854938, -112335944, -1280442601,
                -394561261, -720482531, -1758890109, -1043422305, -1660068497, -2116737866, -938547895, -1356554799,
                -1901088227, -312989793, -1043873547, -365353110, -2093033965, -549547175, -1975968354, -78477257,
                -758085163, -877135268, -1373901209, -899893640, -1673527116, -64269363, -1746261807, -1624145102,
                -1837542364, -1432713193, -1146116416, -829708186, -894236080, -1034105071, -1193677865, -1786173659,
                -1369499519, -1243770035, -1366663405, -1163965565, -965852921, -2140764580, -751572114, -79423431,
                -496948160, -983787647, -1579281033, -239023377, -1086722888, -1089944401, -2089195681, -787527130,
                -1029242954, -1430515847, -1482027529, -1907323632, -314751109, -1902154214, -576699771, -375772384,
                -985812280, -1533111019, -1052880280, -1366663096, -1691942554, -1623825786, -1616183027, -1985021538,
                -586003982, -1307156477, -497893481, -1032756066, -322141157, -357196787, -1505491509, -1128987954,
                -1682395760, -185513960, -525717189, -457240713, -1607884623, -329341910, -1699136951, -814667131,
                -1345261204, -1377332367, -360707259, -1730664348, -28840939, -1394162162, -251043334, -2050675153,
                -1164842898, -601894638, -579925812, -235933071, -1130524026, -1004886548, -1927071705, -1362440481,
                -1736423855, -1606669891, -1360164242, -1184356782, -1847610123, -1812943438, -113749048, -1699325630,
                -1698682008, -2081863011, -1135309455, -1273771957, -283499406, -1621742296, -503572545, -1255197277,
                -288404732, -96858630, -2062297268, -1313878238, -393632024, -1013720940, -212874850, -329189367,
                -962550665, -2027440836, -1791143764, -1717813687, -764139369, -1332212259, -127471402, -1379327612,
                -1453260580, -1942458360, -233330893, -956204137, -593390886, -1127309629, -1466404929, -1625830779,
                -1870407822, -1152740736, -1547695023, -2120978645, -1391659769, -1530938135, -1074390064, -1756062977,
                -956383841, -55400329, -1351440099, -1860257169, -1617894253, -2024677777, -1237386754, -895714799,
                -1775269309, -1339488792, -1246525123, -791404918, -140239828, -1084655303, -708816802, -687755028,
                -1989257946, -1649437507, -41507037, -923717824, -1861938586, -1309365052, -811614467, -77019712,
                -277068443, -896902475, -1726461396, -651955223, -508203440, -771722508, -898421370, -674307214,
                -1871488412, -1280869537, -841768389, -248783178, -369560007, -1549352874, -510909066, -1299268684,
                -660576630, -1206930017, -1658497581, -908125002, -815980897, -1071794376, -1322698416, -480265088,
                -91932740, -1828709298, -997907415, -1619524945, -864404328, -361449022, -1969764379, -1546525592,
                -356929711, -440184861, -1178350207, -1997260666, -811982622, -1090442319, -2012468715, -730775980,
                -1101334396, -802924926, -2075671999, -1832699285, -1934476625, -1541268908, -2019181652, -1772834904,
                -567592590, -403182690, -515806830, -364613363, -61660036, -216340166, -393234362, -544171576,
                -47449340, -1217269868, -240690625, -57338428, -1506265279, -1896548513, -282033642, -287509715,
                -656397617, -1726831885, -570727333, -941585249, -1461528755, -1518642106, -1920529324, -1539051721,
                -38501563, -1543351500, -234751918, -2103767263, -441307530, -537400342, -1746761077, -73147560,
                -116276048, -39426569, -1697381242, -832290330, -1555110739, -1888047867, -880630872, -1756437508,
                -931590707, -2080862185, -914806839, -726687614, -97719142, -1506499269, -1077023914, -1903803434,
                -1584075022, -279086377, -1636874785, -1407711381, -1503683894, -2118544994, -523137819, -711086999,
                -89858813, -1660016826, -395978969, -1418701551, -494100182, -341372597, -2066080760, -1994091390,
                -209125002, -501374271, -611209034, -1815451327, -880676053, -476094635, -597404820, -1449931750,
                -2021913487, -391031921, -1453238660, -16950381, -1839113523, -738404885, -1137685618, -1648236857,
                -1860363752, -1869561670, -1179799317, -1577541608, -272347488, -629717272, -1819325720, -1793561210,
                -2017776682, -1967601972, -575017525, -2048179549, -684619848, -1963525255, -702970439, -115069743,
                -1184346922, -1663193993, -1792930019, -1689726828, -506708814, -1945391287, -1018110550, -2054118997,
                -2036120239, -704824400, -1526868361, -1154735913, -1540864580, -1289582426, -1503103240, -1425137700,
                -1680942125, -483964683, -1727086878, -703771095, -171262559, -574752024, -157806872, -2123967459,
                -1061463330, -562230630, -101675893, -786805190, -1356788418, -398925064, -160324671, -1788739952,
                -493069903, -2041636198, -683313532, -1769526887, -1721384624, -1285404778, -1777588645, -627154405,
                -885883352, -592638650, -139827441, -124891783, -2064315954, -765067117, -673308356, -311805136,
                -1118451178, -701372381, -1385284863, -10367602, -958058892, -454260033, -1525099587, -1007168660,
                -160491083, -1504081305, -576570858, -85368396, -1851706270, -1188094460, -515902952, -1660494474,
                -1443137619, -1816178437, -1950876798, -80893070, -1863290077, -1917408500, -632568806, -71168230,
                -302792631, -2000197405, -932049197, -1381778007, -390682550, -867097105, -734571752, -1938814230,
                -1769920023, -879503745, -1844089342, -649685542, -174735201, -1583893876, -1014367402, -421690456,
                -2099550285, -89482984, -899078680, -1105827938, -152867978, -1744711318, -1531125531, -1087192543,
                -1626160142, -910998893, -894358635, -1374342182, -642902380, -635015747, -973894108, -1917101676,
                -1158179393, -600173204, -1121791197, -844050090, -761900502, -1176808277, -1034877095, -684424876,
                -787383243, -232099389, -897206986, -1529778748, -1554164249, -1739425550, -101634649, -917064216,
                -1205629987, -953946532, -962316302, -1735029751, -1535092533, -684569201, -1895944448, -625639539,
                -137874389, -1559523378, -1261038518, -463226932, -500929966, -1060130789, -598772484, -167170064,
                -178270547, -1187258986, -1481214622, -1649579957, -1832372370, -416258079, -283156417, -83844465,
                -400500352, -1429248900, -254394790, -1215881393, -822750760, -922928295, -671197622, -868983625,
                -1695022673, -1710854634, -1921448032, -963240638, -1994788697, -1897224031, -420178020, -1430503692,
                -1549953420, -669608622, -210534468, -319509385, -882144618, -726883358, -320094679, -1314984157,
                -1245013328, -1274860713, -544892555, -967465593, -891224883, -1492122149, -1855905590, -944733124,
                -1108387958, -1503416199, -12093694, -1832948124, -1775538546, -566920656, -708005770, -1329369301,
                -2105537576, -979081035, -1570767173, -311856053, -11091452, -1898575641, -147455267, -1730270227,
                -753280889, -384898170, -311838879, -471221232, -737091774, -892727094, -1134650478, -1513181159,
                -1052355729, -1602627559, -2053652770, -904582586, -2087863586, -2029932471, -264276238, -1079689773,
                -1939601645, -615141287, -112657089, -1711924048, -59350034, -1021585157, -864038292, -616229163,
                -1615905419, -450736242, -49823819, -326125482, -1452679295, -1429458645, -167036161, -1140133081,
                -1802486816, -1494898885, -2127423386, -532735095, -1256393136, -1218081825, -1390205146, -798274908,
                -1144381616, -1982885033, -1974171128, -572371034, -1313136340, -1447334749, -1859406926, -234533301,
                -1839044907, -1720049807, -1564678886, -1395951477, -567454799, -568357332, -131328370, -131582492,
                -739351061, -1299624006, -855561061, -1804185139, -621148902, -1504878994, -404034281, -1640700714,
                -36861377, -1125536739, -73676142, -758439394, -485085212, -793805558, -1758778747, -224710267,
                -1409941718, -1779992617, -825045226, -481394846, -223813414, -1999722497, -620535989, -1568118679,
                -422862680, -1641854005, -1200429745, -1043036089, -528548110, -627209762, -252731225, -2054750244,
                -179835330, -67030820, -2083698608, -1813294347, -1802607169, -249176058, -1230554170, -428155431,
                -1950924459, -431117346, -1485992859, -383760304, -1338996103, -1308058675, -1552622772, -107851272,
                -1181197331, -847480278, -23971303, -457101302, -426424856, -1326860712, -1154633307, -333278748,
                -164819384, -1183411501, -1160833357, -2052220793, -262945911, -474919393, -1149875476, -486643997,
                -1200495174, -132340719, -1958538797, -1326696722, -1227435283, -364264309, -2077809570, -472905213,
                -96803452, -1288753917, -1286342868, -1423014927, -1546763261, -569647240, -1797114862, -614514528,
                -706028495, -100880043, -532426214, -1602344914, -773189411, -1831058231, -698401871, -65850061,
                -2041459563, -153957805, -129364724, -978039379, -952523866, -1574410769, -745891053, -1386896980,
                -2108215410, -2131828962, -828115859, -2077582607, -1006293740, -1103036839, -1685539332, -90273957,
                -1884967935, -2021930757 };
        int k = 1000;

        System.out.println(Arrays.toString(medianSlidingWindow(nums, k)));
    }
}
